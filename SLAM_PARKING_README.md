# SLAM + EKF 기반 자율 주차 시스템

## 개요

이 프로그램은 **Extended Kalman Filter (EKF)** 기반 SLAM을 이용하여 로봇이 자신의 위치를 확신한 후, 그 위치에서 목표 주차 위치까지의 최적 경로를 계획하고 **PID 제어기**로 경로를 추적하여 주차하는 시스템입니다.

---

## 시스템 구성

### Phase 1: SLAM + EKF 로컬라이제이션

**목표**: 로봇이 불확실성(uncertainty)을 줄여가며 자신의 위치를 확신하도록 함

**방식**:
- 맵 중앙에서 출발하여 **원형 경로**로 이동 (8 방향)
- 각 단계에서 4개의 랜드마크를 센싱
- EKF 예측-업데이트를 반복하여 위치 추정값과 불확실성 갱신
- **불확실성 < 0.5m** 달성 시 위치 확신 상태로 진입

**EKF 설정**:
```python
상태 벡터: x = [x, y, θ]
프로세스 노이즈: Q = diag([0.005, 0.005, 0.005])
측정 노이즈: R = 0.16 (각 랜드마크별)
초기 불확실성: P = I * 1.0
```

### Phase 2: 최적경로 계획 (A* + Smooth)

**목표**: 확신된 현재 위치에서 주차 위치로 이동할 최적 경로를 계획

**과정**:
1. **A* 경로 탐색**: 그리드 맵 기반 최적 경로 탐색
   - 시작점: 확인된 현재 위치
   - 목표점: 주차 위치 (G1 또는 P2)
   - 8 방향 탐색 지원

2. **경로 스무딩** (smooth_path_nd 함수):
   - 각도 제약을 만족하도록 경로를 부드럽게 변환
   - 로봇의 실제 운동 가능성 고려
   - 파라미터: α=0.1, β=0.3, max_iter=500

### Phase 3: PID 제어기로 주차

**목표**: 계산된 smooth path를 따라 정확하게 이동하여 주차 위치 도달

**제어 방식**:
- **경로 추적 오차**: 현재 위치에서 최근접 경로점까지의 수직 거리
- **PID 제어**: 오차를 최소화하도록 조향 생성
  - Kp = 1.0 (비례 이득)
  - Ki = 0.05 (적분 이득, anti-windup)
  - Kd = 0.2 (미분 이득)

**실시간 위치 추정**:
- 매 단계마다 랜드마크 재측정
- EKF로 위치 재추정
- 경로 추적 오차 모니터링

---

## 주요 특징

### 1. 강건한 위치 추정
- **EKF 기반**: 비선형 운동 모델 대응
- **불확실성 추적**: 위치 신뢰도를 수치적으로 추정
- **연속 업데이트**: 주차 과정 전체에서 위치 갱신

### 2. 최적 경로 계획
- **A* 알고리즘**: 장애물 회피
- **경로 스무딩**: 실제 구동 가능한 궤적 생성
- **동적 계획**: 위치 확신 후 계획 수행

### 3. PID 기반 경로 추적
- **교차 추적 오차 제어**: 경로 벗어남 방지
- **다차원 벡터 PID**: 2D 평면에서의 독립적 제어
- **Anti-windup**: 적분 항 포화 방지

### 4. 실시간 시각화
- **애니메이션**: 각 단계별 로봇 궤적 표시
- **오차 그래프**: 위치 오차 및 불확실성 변화 추적
- **경로 추적 오차**: 목표 경로와의 거리 모니터링

---

## 실행 방법

```bash
python ass/slam_parking.py
```

### 출력 결과

```
======================================================================
SLAM + EKF 기반 자율 주차 시스템
======================================================================

주차 위치: (55.0, 5.0)

======================================================================
Phase 1: SLAM + EKF 로컬라이제이션 (위치 확신도 증가)
======================================================================
시작 위치: (32.50, 25.00)
[Step 0] Pos: (34.07, 24.91), Unc: 0.386m, Error: 0.111m, Detected: 4/4

✓ 위치 확신 달성! (Step 0, 불확실성: 0.386m)
  확인된 위치: (34.15, 24.83)

======================================================================
Phase 2: 최적경로 계획 (A* + Smooth)
======================================================================
현재 위치: (34.15, 24.83)
주차 위치: (55.00, 5.00)
A* 경로: 6개 점
Smooth 경로: 6개 점

======================================================================
Phase 3: PID 제어기로 주차 경로 추적
======================================================================
[Parking Step 0] Pos: (34.09, 24.93), PathErr: 2.877m, EstErr: 0.185m, Goal: 29.189m
...
✓ 주차 완료! (Step 500)
  최종 위치: (X, Y)
  목표 위치: (55.00, 5.00)

✓ 애니메이션 저장: slam_parking_animation.gif

======================================================================
자율 주차 완료!
======================================================================
```

---

## 생성 파일

| 파일명 | 설명 |
|--------|------|
| `slam_parking_animation.gif` | 주차 과정 시각화 (2패널) |
| 좌측 패널 | 지도 + 로봇 궤적 + 랜드마크 + 불확실성 원 |
| 우측 패널 | 위치 오차 & 불확실성 & 경로 추적 오차 |

### 애니메이션 정보
- **FPS**: 10 fps (100ms/frame)
- **총 프레임**: SLAM Phase + Parking Phase 합계
- **형식**: GIF (pillow writer)

---

## 알고리즘 상세

### EKF 예측 단계

$$\hat{x}_{t|t-1} = \hat{x}_{t-1|t-1} + \begin{bmatrix} \Delta x \\ \Delta y \\ 0 \end{bmatrix}$$

$$P_{t|t-1} = F_t P_{t-1|t-1} F_t^T + Q$$

### EKF 업데이트 단계

**측정 잔차**:
$$y = z_t - h(x)$$

여기서 $h(x) = \text{distance to landmark}$

**Kalman 이득**:
$$K_t = P_{t|t-1} H_t^T (H_t P_{t|t-1} H_t^T + R)^{-1}$$

**상태 갱신**:
$$\hat{x}_{t|t} = \hat{x}_{t|t-1} + K_t y_t$$

$$P_{t|t} = (I - K_t H_t) P_{t|t-1}$$

### PID 제어

**제어 입력**:
$$u(t) = K_p e(t) + K_i \int_0^t e(\tau) d\tau + K_d \frac{de(t)}{dt}$$

여기서 $e(t)$ = 경로 추적 오차 벡터

---

## 주요 파라미터 튜닝

### SLAM 관련
- **불확실성 threshold**: 0.5m (위치 확신 기준)
- **프로세스 노이즈 Q**: 0.005 (낮을수록 신뢰도 높음)
- **측정 노이즈 R**: 0.16 (센서 정확도 반영)

### 경로 계획 관련
- **Smooth alpha**: 0.1 (데이터항 가중치)
- **Smooth beta**: 0.3 (부드러움 가중치)
- **목표 거리**: 1.0m (도착 판정 기준)

### PID 제어 관련
- **Kp**: 1.0 (비례 게인, 응답속도 결정)
- **Ki**: 0.05 (적분 게인, 정상상태 오차 제거)
- **Kd**: 0.2 (미분 게인, 안정성 향상)

---

## 구현된 모듈 연계

```
slam_parking.py
├── module.MySlam          ← 맵 생성 (maze_map)
├── module.MySensor        ← Circle_Sensor (랜드마크 센싱)
├── module.MyControl       ← SimpleBicycleModel
├── module.MyPlanning      ← PIDVec, smooth_path_nd, point_to_path_min_distance_nd
└── module.MyRobot_with_localization ← Moblie_robot (EKF 통합)
```

---

## 주의사항

1. **초기 위치**: 맵 중앙에서 시작 (랜드마크 모두 센싱 가능)
2. **랜드마크**: 4개 고정 (25,20), (40,15), (15,30), (35,35)
3. **센싱 범위**: 최대 50m (랜드마크 배치 고려)
4. **경로 계획**: 그리드 기반 (5m 셀 크기)

---

## 확장 가능성

### 추가 개선 사항
1. **적응형 PID**: 속도에 따른 동적 게인 조정
2. **Particle Filter**: 다중 가설 추적
3. **재계획**: 경로 추적 오차 크면 재계획 실행
4. **센서 융합**: 다양한 센서 데이터 통합
5. **실시간 장애물 회피**: 예측 불가능한 장애물 처리

---

## 참고 문헌

- Kalman, R. E. (1960). "A New Approach to Linear Filtering and Prediction Problems"
- Thrun, S., Burgard, W., & Fox, D. (2005). "Probabilistic Robotics"
- Beaumont, A. (2012). "Path Planning Algorithms"

---

**작성일**: 2024년 12월
**환경**: Python 3.x, NumPy, Matplotlib, 로보틱스 모듈
